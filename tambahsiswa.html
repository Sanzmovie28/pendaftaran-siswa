<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Form Pendaftaran Siswa Baru SMAN GAMA 12</title>
    <link rel="stylesheet" href="style.css">
    <style>
      .container {
        width: 50% !important;
      }

      h3 {
        border-bottom: 1px solid black;
        padding-bottom: 15px;
        margin-bottom: 10px;
      }

      table {
        width: 100%;
      }

      td.radio {
        display: flex;
        justify-content: flex-start;
      }

      input,
      textarea {
        width: 100%;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <div class="content">
        <h3>Form Pendaftaran Siswa Baru SMAN 404 Sidoarjo 2025</h3>
        <p>Silahkan isi form di bawah ini dengan benar!</p><br>
        <form action="" id="formPendaftaran">
          <table cellspacing="10">
            <tr>
              <td>
                <label for="nama">Nama Siswa</label>
              </td>
              <td>:</td>
              <td><input type="text" id="nama" name="nama" required="required"></td>
            </tr>
            <tr>
              <td>
                <label for="jenis_kelamin">Jenis Kelamin</label>
              </td>
              <td>:</td>
              <td class="radio">
                <select id="jenis_kelamin" name="jenis_kelamin" required="required">
                  <option value="">-- Pilih Jenis Kelamin --</option>
                  <option value="Laki-laki">Laki-laki</option>
                  <option value="Perempuan">Perempuan</option>
                </select>
              </td>
            </tr>
            <tr>
              <td>
                <label for="alamat">Alamat Rumah</label>
              </td>
              <td>:</td>
              <td>
                <textarea id="alamat" name="alamat" rows="4" cols="40" required="required"></textarea>
              </td>
            </tr>
            <tr>
              <td>
                <label for="asal_sekolah">Asal Sekolah</label>
              </td>
              <td>:</td>
              <td><input type="text" id="asal_sekolah" name="asal_sekolah" required="required"></td>
            </tr>
            <tr>
              <td>
                <label for="nilai_akhir">Nilai Akhir</label>
              </td>
              <td>:</td>
              <td><input type="number" id="nilai_akhir" name="nilai_akhir" step="0.01" required="required"></td>
            </tr>
            <tr>
              <td>
                <label for="foto">Foto Siswa</label>
              </td>
              <td>:</td>
              <td><input type="file" id="foto" name="foto" accept="image/*" required="required"></td>
            </tr>
            <tr>
              <td>&nbsp;</td>
              <td>&nbsp;</td>
              <td>
                <button type="submit">Daftar</button>
              </td>
            </tr>
          </table>
        </form>

        <!-- Supabase JS Library -->
        <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
        <script>
          // Ganti dengan info project Supabase Anda
          const SUPABASE_URL = 'https://nkbyswllkimywfosujxz.supabase.co';
          const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5rYnlzd2xsa2lteXdmb3N1anh6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcyMTI3NzcsImV4cCI6MjA3Mjc4ODc3N30.jTx6kR64yz87YPwQMTY8Q1qUkk9hu5YHqvlyKUBIQyM';

          const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

          const form = document.getElementById('formPendaftaran');

          form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const nama = document
              .getElementById('nama')
              .value;
            const jenis_kelamin = document
              .getElementById('jenis_kelamin')
              .value;
            const alamat = document
              .getElementById('alamat')
              .value;
            const asal_sekolah = document
              .getElementById('asal_sekolah')
              .value;
            const nilai_akhir = parseFloat(document.getElementById('nilai_akhir').value);
            const foto = document
              .getElementById('foto')
              .files[0];

            if (!foto) {
              alert('Foto harus diunggah.');
              return;
            }

            try {
              // 1. Upload file ke Supabase Storage
              const fileName = `${Date.now()}_${foto.name}`;
              const {data: fileData, error: uploadError} = await supabase
                .storage
                .from('foto-siswa') // Pastikan bucket storage Anda bernama 'foto-siswa'
                .upload(fileName, foto);

              if (uploadError) 
                throw uploadError;
              
              // 2. Dapatkan public URL dari file yang diupload
              const {data: publicUrlData} = supabase
                .storage
                .from('foto-siswa')
                .getPublicUrl(fileName);

              const foto_url = publicUrlData.publicUrl;

              // 3. Simpan data ke database
              const {data, error} = await supabase
                .from('siswa')
                .insert([
                  {
                    nama,
                    jenis_kelamin,
                    alamat,
                    asal_sekolah,
                    nilai_akhir,
                    foto_url
                  }
                ]);

              if (error) 
                throw error;
              
              alert('Data siswa berhasil disimpan!');
              form.reset();

            } catch (err) {
              console.error('Gagal menyimpan data:', err.message);
              alert('Terjadi kesalahan saat menyimpan data.');
            }
          });
        </script>

      </div>
    </div>
  </body>

</html>
